-- Shoot Cross
-- Initscript

if (VERSION >= 0.9) then
  dofile("./levels/compat.lua")
end

pic_box    = images:load("./bitmap/box.bmp")
pic_paper  = images:load("./bitmap/paper.bmp")
pic_maple  = images:load("./bitmap/maple.bmp")
pic_house1 = images:load("./bitmap/haus1.bmp")
pic_house2 = images:load("./bitmap/haus2.bmp")

sound_hit     = gsound:load_sound("./bitmap/hit.wav")
sound_away    = gsound:load_sound("./bitmap/away.wav")
sound_perfect = gsound:load_sound("./bitmap/perfect.wav")

mybase = bases:add(  0, PLAYER_BASE, 1243, 1883-48 )
       objects:add(  0, OBJ_PILE,  mybase:get_x() + 102,  mybase:get_y() + 18 )
mybase = bases:add(  1, ENEMY_S_BASE,  356,  446 )
mybase = bases:add(  2, ENEMY_BASE_LEFT, 2116,  589 )
mybase = bases:add(  3, ENEMY_BASE_RIGHT, 2125,  589 )
mybase = bases:add(  4, ENEMY_S_BASE,  735,  348 )
mybase = bases:add(  5, ENEMY_BASE_LEFT,  306,  249 )
mybase = bases:add(  6, ENEMY_BASE_RIGHT,  315,  249 )

-- Also take a look at the .lvl file for some "credits"!

myob = objects:add(  99, pic_maple,   561,   842,           0,        10 )
myob:set_maxframe(0)

myob = objects:add(  99, pic_maple,  1095,   631,           0,        10 )
myob:set_startframe(1)

myob = objects:add(  7, pic_house2,   621,   540,           0,        10 )
myob = objects:add(  8, pic_house1,   399,   410,           0,        10 )
myob = objects:add(  1, OBJ_BUILDING4, 1194,  396 )
myob = objects:add(  2, OBJ_BUILDING2, 1625,  484 )
myob = objects:add(  3, OBJ_BUILDING3, 1655,  509 )
myob = objects:add(  4, OBJ_BUILDING3, 1687,  509 )
myob = objects:add(  5, OBJ_BUILDING3, 1719,  509 )
myob = objects:add(  9, OBJ_BUILDING3,  214,  800 )
myob = objects:add( 10, OBJ_BUILDING3,  246,  800 )
myob = objects:add( 11, OBJ_BUILDING1,  278,  806 )
myob = objects:add( 12, OBJ_BUILDING1,  316,  806 )
myob = objects:add( 13, OBJ_BUILDING4,  292,  595 )
myob = objects:add( 14, OBJ_TREE2,  131,  319 )
myob = objects:add( 15, OBJ_BUILDING4_2,  156,  333 )
myob = objects:add( 16, OBJ_BUILDING1,  632,  326 )
myob = objects:add( 17, OBJ_BUILDING1,  594,  326 )
myob = objects:add( 18, OBJ_BUILDING1,  670,  326 )
myob = objects:add( 19, OBJ_MAN1, 2123,  582 )
myob = objects:add( 20, pic_house1,  1750,   750,           0,        10 )
myob = objects:add( 21, OBJ_BUILDING4, 1640, 1793-48)
myob = objects:add( 22, OBJ_BUILDING1, 1580, 1140 )
myob = objects:add( 23, OBJ_BUILDING3, 1548, 1134 )
myob = objects:add( 24, OBJ_BUILDING4_2, 1445, 1439 )
myob = objects:add( 25, pic_house2,  1074,  1212,           0,        10 )
myob = objects:add( 26, OBJ_BUILDING2,  479, 1073 )
myob:set_bound_w(-(myob:get_width()))
myob:set_bound_h(-(myob:get_height()))
myob = objects:add( 27, OBJ_TREE2,  660, 1093 )
myob = objects:add( 28, OBJ_BUILDING4_2,  595, 1105 )
myob = objects:add( 29, OBJ_BUILDING4,  691, 1076 )
myob = objects:add( 30, OBJ_MAN1,  510, 1068 )
myob = objects:add( 47, OBJ_MAN1,  313,  242 )
myob = objects:add( 48, OBJ_PILE,  328,  239 )
myob = objects:add(  0, OBJ_BUILDING4_2, 1322,  671 )
myob = objects:add(  1, OBJ_TREE2, 1292,  662 )
myob = objects:add(  2, OBJ_TREE2, 1386,  657 )
myob = objects:add(  0, pic_house1,  2161,  1469,           0,        10 )
myob = objects:add(  1, OBJ_BUILDING3, 2223, 1471 )
myob = objects:add(  2, OBJ_TREE2, 1810, 1378 )
myob = objects:add(  3, OBJ_TREE, 1779, 1367 )
myob = objects:add(  4, OBJ_POOL1, 1898, 1685 )
fountain = objects:add(234, OBJ_PPILE1, 1980, 1677 )
myob = objects:add(  6, OBJ_BUILDING1, 2238, 1765 )
myob = objects:add(  7, OBJ_BUILDING1, 2201, 1765 )
myob = objects:add(  8, OBJ_BUILDING2, 2106, 1734 )
myob:set_bound_w(-(myob:get_width()))
myob:set_bound_h(-(myob:get_height()))

myob = objects:add_special(  150, SPOBJ_TELEPORT1, 2711-7*48,  790, 151 )
myob = objects:add_special(  151, SPOBJ_TELEPORT1, 1210, 1795-48, 151)
myob:set_invisible(1)
myob:set_active(0)

-- Briefkaesten

mailbox = {}
mailbox[1]  = objects:add_special( 100, pic_box,  1631,  1780-48,        0,        5 )
mailbox[2]  = objects:add_special( 100, pic_box,  1458,  1415,           0,        5 )
mailbox[3]  = objects:add_special( 100, pic_box,  1521,  1133,           0,        5 )
mailbox[4]  = objects:add_special( 100, pic_box,  1165,  1234,           0,        5 )
mailbox[5]  = objects:add_special( 100, pic_box,   524,  1082,           0,        5 )
mailbox[6]  = objects:add_special( 100, pic_box,   183,   789,           0,        5 )
mailbox[7]  = objects:add_special( 100, pic_box,   339,   594,           0,        5 )
mailbox[8]  = objects:add_special( 100, pic_box,   623,   536,           0,        5 )
mailbox[9]  = objects:add_special( 100, pic_box,   376,   416,           0,        5 )
mailbox[10] = objects:add_special( 100, pic_box,   713,   319,           0,        5 )
mailbox[11] = objects:add_special( 100, pic_box,   170,   308,           0,        5 )
mailbox[12] = objects:add_special( 100, pic_box,  1237,   391,           0,        5 )
mailbox[13] = objects:add_special( 100, pic_box,  1680,   484,           0,        5 )
mailbox[14] = objects:add_special( 100, pic_box,  2135,   563,           0,        5 )
mailbox[15] = objects:add_special( 100, pic_box,  1814,   749,           0,        5 )
mailbox[16] = objects:add_special( 100, pic_box,   675,  1070,           0,        5 )
mailbox[17] = objects:add_special( 100, pic_box,   337,   223,           0,        5 )
mailbox[18] = objects:add_special( 100, pic_box,  1360,   642,           0,        5 )
mailbox[19] = objects:add_special( 100, pic_box,  2178,  1445,           0,        5 )
mailbox[20] = objects:add_special( 100, pic_box,  2127,  1709,           0,        5 )

-- Der schoene Part der Datei ^_^

papers_left = 30
papers_delivered = 0
perfect_delivery = 0
perfect_bonus = 20
money = 0
seconds_used = 0
seconds_extra = 0
win_var = 0
real_game_time = 0
globals.particle_gravity = 0.06

if (LANGUAGE == LANG_DE) then
  text_papers_left      = "ZEITUNGEN: "
  text_money            = "BELOHNUNG: $"
  text_perfect_delivery = "PERFEKTE LIEFERUNG!"
  thatosd = playmap[1].osd:add(0, 10, 10, 135, 41, OSDBIT_SCREEN)
else
  text_papers_left      = "PAPERS: "
  text_money            = "INCOME: $"
  text_perfect_delivery = "PERFECT DELIVERY"
  thatosd = playmap[1].osd:add(0, 10, 10, 109, 41, OSDBIT_SCREEN)
end

player[1]:set_lifes(1)

local a
for a = 1, 6 do
  player[1]:set_weapon(a-1, W_NONE, 0, 0)
end

local s
for s = 1, 20 do
  mailbox[s]:set_maxframe(0)
end

function update_osd()
  thatosd:clear(globals.col_white)
  thatosd:draw_rectangle(globals.col_lblue)
  if perfect_delivery == 0 then
    thatosd:draw_text(FONT_IMPACT14, text_papers_left .. papers_left, globals.col_lblue, 4, 2)
    thatosd:draw_text(FONT_IMPACT14, text_money ..  money, globals.tbl_blue[10], 4, 20)
  else
    thatosd:draw_text(FONT_IMPACT10, text_perfect_delivery, globals.col_orange, 4, 4)
    thatosd:draw_text(FONT_IMPACT14, text_money ..  money, globals.tbl_blue[10], 4, 20)
  end
end
update_osd()

function main_loop()
  if mod(globals.game_time - real_game_time, 60) == 0 and win_var < 2 then
    if money > 0 then
      money = money - 1
      seconds_used = seconds_used + 1
    end
    update_osd()
  end

  if mod(globals.game_time, 2) == 0 then
    effects.pixels:add(8, fountain:get_x() + fountain:get_width() / 2, fountain:get_y()-1, 0, 0, -0.57, -2.8, 600, PIX_BLUE, 10, 200, 32, 500, 500)
  end

  if player[1]:get_y() > 1700 and win_var == 1 then
    player[1]:set_mission_status(1)
    win_var = 2
  end

  if get_key(59) == 1 then
    money = 0
    update_osd()
    win_var = 3
  end
end

function hook_keyboard_hit_0(key)
  if player[1].controls:shoot() == 1 and papers_left > 0 and win_var < 2 then
    paper = objects:add_special( 200, pic_paper, player[1]:get_x(), player[1]:get_y())
    paper:set_xspd(player[1]:get_xspd() + sin(player[1]:get_head()) * 4)
    paper:set_yspd(player[1]:get_yspd() - cos(player[1]:get_head()) * 4)
    papers_left = papers_left - 1
    update_osd()
  elseif player[1].controls:shoot() == 1 and papers_left == 0 then
    player[1]:set_mission_status(1)
  end
end

function hook_object_with_object_0(ob1, ob2)
  if ob1:get_nr() == 200 then
    if ob2:get_nr() == 100 and ob2:get_maxframe() == 0 then
      ob2:set_maxframe(4)
      ob2:set_startframe(4)
      gsound:play_sound(sound_hit, 100)
      gsound:play_sound(sound_hit, 100)
      papers_delivered = papers_delivered + 1
      if papers_delivered == 20 and papers_left == 10 then
        perfect_delivery = 1
        money = money + perfect_bonus
        gsound:play_sound(sound_perfect, 100)
      end
      if money == 0 then real_game_time = globals.game_time; money = money + 1; seconds_extra = seconds_extra + 1 end
      money = money + 10
      update_osd()
    else
      gsound:play_sound(sound_away, 100)
    end
    objects:remove_special(ob1)
  end
end

function hook_object_update_0(ob)
  if ob:get_nr() == 200 then
    if playmap[1]:is_pixel(ob:get_x() - 1, ob:get_y() - 1) == 1 or playmap[1]:is_pixel(ob:get_x() + 6, ob:get_y() - 1) == 1 or playmap[1]:is_pixel(ob:get_x() - 1, ob:get_y() + 6) == 1 or playmap[1]:is_pixel(ob:get_x() + 6, ob:get_y() + 6) == 1 then
      objects:remove_special(ob)
      gsound:play_sound(sound_away, 100)
    end
  elseif ob:get_nr() == 99 then
    if mod(globals.game_time, 30) == 0 or mod(globals.game_time, 30) == 5 or mod(globals.game_time, 30) == 10 then
      ob:set_y(ob:get_y() + 1)
    elseif mod(globals.game_time, 30) == 15 or mod(globals.game_time, 30) == 20 or mod(globals.game_time, 30) == 25 then
      ob:set_y(ob:get_y() - 1)
    end
  end
end

function hook_player_with_spobject_0(pl, ob)
  if ob:get_nr() == 150 and win_var < 3 then
    win_var = 1
  end
end

-- Auswertung
globals.use_user_stats = 1
function hook_exit_level_0()
  sum = 7

  globals.user_stats[3]:set_textcolor(globals.col_green)
  globals.user_stats[3]:set_valuecolor(0, globals.col_yellow)
  globals.user_stats[4]:set_textcolor(globals.col_green)
  globals.user_stats[4]:set_valuecolor(0, globals.col_orange)
  globals.user_stats[5]:set_textcolor(globals.col_green)
  globals.user_stats[5]:set_valuecolor(0, globals.col_yellow)
  globals.user_stats[sum]:set_textcolor(globals.col_green)
  globals.user_stats[sum]:set_valuecolor(0, globals.col_white)

  if (LANGUAGE == LANG_DE) then
    globals.user_stats[3]:set_text("Zeitungen geliefert ($10)")
    globals.user_stats[4]:set_text("Benoetigte Sekunden (-$1)")
    if perfect_delivery == 1 then globals.user_stats[5]:set_text("Perfekte Lieferung!")
    elseif papers_delivered == 20 then globals.user_stats[5]:set_text("Mehr als 20 Zeitungen verbraucht")
    else globals.user_stats[5]:set_text("Einige Haushalte nicht versorgt") end
    if win_var == 3 then globals.user_stats[sum]:set_text("Heutige Einnahmen (ESC gedrueckt!)")
                    else globals.user_stats[sum]:set_text("Heutige Einnahmen") end
  else
    globals.user_stats[3]:set_text("Papers delivered ($10)")
    globals.user_stats[4]:set_text("Seconds needed (-$1)")
    if perfect_delivery == 1 then globals.user_stats[5]:set_text("Perfect delivery!")
    elseif papers_delivered == 20 then globals.user_stats[5]:set_text("More papers used than necessary")
    else globals.user_stats[5]:set_text("Some people got no paper") end
    if win_var == 3 then globals.user_stats[sum]:set_text("Today's income (ESC pressed!)")
                    else globals.user_stats[sum]:set_text("Today's income") end
  end

  globals.user_stats[3]:set_value(0, papers_delivered * 10)
  globals.user_stats[4]:set_value(0, seconds_used - seconds_extra)
  if perfect_delivery == 1 then globals.user_stats[5]:set_value(0, perfect_bonus)
  else globals.user_stats[5]:set_value(0, 0) end
  globals.user_stats[sum]:set_value(0, money .. " Dollar")
  globals:set_highscore(money)
end