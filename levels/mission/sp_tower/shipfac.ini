-- The Factory
-- INI file

dofile("./levels/libhelp.sc")

-- Texte
if (globals.language == LANG_DE) then

text_relash_start = 
  "[c:white]Hallo Commander?[w:30] Hier Relash.[w:10] Wir kennen uns ja schon, also " ..
  "koennen wir uns die ueblichen Floskeln sparen.[w:30] Lust auf eine " ..
  "neue Rettet-Relash-vor-den-boesen-Aliens - Mission? Nun denn, auf ans " ..
  "Werk![w:60][br]" ..
  "Wie Sie ja schon mitbekommen haben, hat man meine alte Alien-Muehle hier " ..
  "in ein Wissenschaftsschiff umgebaut. Klar, dass die dann wieder mich " ..
  "haben wollten, um das Teil zu fliegen...[w:30] Hier der geplante " ..
  "Missionsablauf:[w:30][c:orange] Ich fliege tief in den Sueden zur " ..
  "Fabrik und Sie beschuetzen mich vor feindlichen Angriffen. " ..
  "[w:60][c:white]Dort angekommen werde ich ein wenig brauchen, " ..
  "um das Kraftfeld zu untersuchen. Danach verschwinden wir so schnell " ..
  "wie moeglich.[w:60][br]" ..
  "Ach ja: Sie werden automatisch aufgetankt, wenn Sie sich in meiner Naehe " ..
  "befinden. Zu irgend etwas muss dieses Alien-Zeug ja auch gut sein.[w:60] " ..
  "[br][w:60][br]Okay, " .. player[1]:get_name() ..
  ", ich lege mein Leben mal wieder in " ..
  "Ihre Haende.[w:20] Enttaeuschen Sie mich nicht, ich hab heute Abend " ..
  "ein Date, das ich auf keinen Fall verpassen moechte.[w:60][br]" ..
  "Fliegen Sie schon mal vor und raeumen Sie ein wenig auf. Ich starte " ..
  "in wenigen Sekunden."

text_relash_helpme1 = 
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Commander? Passen Sie ein wenig auf, sonst kann ich mir den " ..
  "heutigen Abend abschminken!"
  
text_relash_helpme2 =
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Hey, fuer was werden Sie eigentlich bezahlt?! Schnappen Sie " ..
  "sich diese blauen Chaoten, sonst machen die Pixelstaub aus uns!"

text_relash_helpme3 =
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Argh, verdammt nochmal, " .. player[1]:get_name() .. "! " ..
  "In meinem Cockpit brennt es und ich kann das Teil hier kaum mehr " ..
  "steuern. Es ist kritisch. Hoeren Sie?[w:60] KRITISCH!!"
  
text_relash_helpme4 =
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Yikes![w:60] Noch ein oder zwei Treffer, Jimbo, und die Kiste " ..
  "hier fliegt auseinander.[w:20] Hoer mal Junge, das Maedel heisst " ..
  "Eleanore Lashree...[w:60] Sag ihr, dass ich sie liebe...[w:100] " ..
  "Und dass du fuer meinen Tod verantwortlich bist, du Hirnverbrannter! " ..
  "[w:60][c:orange]Das ist deine letzte Chance..."

text_relash_helpme5 = 
  "[c:green][u]Relash:[/u] " ..
  "[c:orange][f:impact14]Aaaaaaaaaaarrrrrrrrrrghhhhhh!"

text_relash_target_in_sight = 
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Okay, wir sind nahe dran, nahe dran...[w:20]"

text_relash_target_reached = 
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Wir haben die Fabrik erreicht. Gut gemacht, Commander![w:20] " ..
  "Geben Sie mir nun eine paar Sekunden, um hier ein paar Daten zu sammeln..."

text_relash_ready = 
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Fertig![w:20] Ich bin[w:10] bin aber nicht ganz sicher, ob " ..
  "ich nicht...[w:40] Moment.[w:60] [c:orange]Scheisse![w:20] " ..
  "[f:impact14]WEG HIER, ABER SCHNELL!!"
  
text_relash_killemall = 
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Hey, da ist ja doch eine Kanone![w:20] [c:orange]Yahooooooooo, kommt " ..
  "her, ihr verrueckten Aliens, ich mach euch alle!!"

text_relash_alldone = 
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Puuuh...[w:30] Mann, das war vielleicht ein Ritt.[w:10] Und " ..
  "wahnsinnigerweise bin ich noch da.[w:60] Groessten Dank fuer den guten " ..
  "Schutz, Commander. Ich werde nun ausspannen...[br]" ..
  "[w:80]Eleanore, ich koooommmmeeee!"

else -- Englische Sprache

text_relash_start = 
  "[c:white]Commander?[w:30] This is Relash.[w:10] We already know us, so we " ..
  "can do shakehands later.[w:30] You like to do a new " ..
  "save-Relash-from-the-big-bad-aliens-mission? Well then, let's go![w:60][br]" ..
  "The scientists transformed my old alien bomber here into a " ..
  "science ship. Sadly. Of course, they had to call me to fly this " ..
  "thing...[w:30] But well, now to the planned mission: " ..
  "[w:30][c:orange] I fly into the south to reach the alien " ..
  "factory and you keep the bad guys away from me. " ..
  "[w:60][c:white]When I'm there, I'm going to need a few seconds to " ..
  "scan the force field they use. When I'm done we fly home as fast " ..
  "as possible.[w:60][br]" ..
  "If you keep your ship near mine you'll automatically be refueled. " ..
  "This alien stuff must have one positive thing though...[w:60] " ..
  "[br][w:60][br]Okay, " .. player[1]:get_name() ..
  ", I lay my life in your hands. Again." ..
  "[w:20] I please you to do your best, cause I'm having " ..
  "a date today with an awsome girl.[w:60][br]" ..
  "So, fly away and do some housekeeping down there. I'll start my " ..
  "engines in a few seconds."

text_relash_helpme1 = 
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Commander? Have a look at me or my girlfriend has to " ..
  "wait tonight!"
  
text_relash_helpme2 =
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Hey, for what are you paid for?! Go catch these " ..
  "blue guys before they transform us to pixel ashes!"

text_relash_helpme3 =
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Argh, bloody hell, " .. player[1]:get_name() .. "! " ..
  "There's smoke and fire in my cockpit and this thing is very hard " ..
  "to control. Situation is critical. Did you understand?[w:60] CRITICAL!!"
  
text_relash_helpme4 =
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Yikes![w:60] One or two more hits, Jimbo, and this thing is going " ..
  "to blow up.[w:20] Hey guy, the girl's name is Eleanore Lashree... " ..
  "[w:60] Tell her that she's my great love...[w:100] " ..
  "And that you are responsible for my dead, you braindead idiot! " ..
  "[w:60][c:orange]This is your last chance..."

text_relash_helpme5 = 
  "[c:green][u]Relash:[/u] " ..
  "[c:orange][f:impact14]Aaaaaaaaaaarrrrrrrrrrghhhhhh!"

text_relash_target_in_sight = 
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Okay, the factory is in reach... just a few moments...[w:20]"

text_relash_target_reached = 
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]We have reached the factory. Good job, Commander![w:20] " ..
  "Please wait a few seconds. I'm going to scan this thing..."

text_relash_ready = 
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Done![w:20] But I am[w:10] not sure, if... " ..
  "[w:40] Wait.[w:60] [c:orange]Shit![w:20] " ..
  "[f:impact14]FLY AWAY! HURRY!!"
  
text_relash_killemall = 
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Hey, I've found a cannon![w:20] [c:orange]Yahooooooooo, " ..
  "come on aliens, eat my bullets!!"

text_relash_alldone = 
  "[c:green][u]Relash:[/u] " ..
  "[c:yellow]Whuiii...[w:30] Man, this was a great ride.[w:10] And " ..
  "I'm here, well up and living.[w:60] Thank you a lot, Commander. " ..
  "I go home now...[br]" ..
  "[w:80]Eleanore, I'm commming!"

end -- Sprache
      
-- Basen erstellen
bases:add(  0, PLAYER_BASE,  308,  733 )
bases:add(  1, PLAYER_BASE, 1784,  637 )

bases:add(  2, ENEMY_BASE_LEFT, 1592, 1937 )
bases:add(  3, ENEMY_BASE_MIDDLE, 1601, 1937 )
bases:add(  4, ENEMY_BASE_MIDDLE, 1640, 1937 )
bases:add(  5, ENEMY_BASE_MIDDLE, 1677, 1937 )
bases:add(  6, ENEMY_BASE_MIDDLE, 1715, 1937 )
bases:add(  7, ENEMY_BASE_RIGHT, 1754, 1937 )
bases:add(  8, ENEMY_BASE_MIDDLE,  815, 1453 )
bases:add(  9, ENEMY_BASE_MIDDLE,  855, 1453 )
bases:add( 10, ENEMY_BASE_MIDDLE,  895, 1453 )
bases:add( 11, ENEMY_BASE_MIDDLE,  933, 1453 )
bases:add( 12, ENEMY_BASE_MIDDLE, 1168, 1452 )
bases:add( 13, ENEMY_BASE_MIDDLE, 1206, 1452 )
bases:add( 14, ENEMY_BASE_MIDDLE, 1246, 1452 )
bases:add( 15, ENEMY_BASE_MIDDLE, 1286, 1452 )

-- Objekte
objects:add(  4, OBJ_BUILDING1,   64,  951 )
objects:add(  5, OBJ_BUILDING1,  101,  950 )
objects:add(  6, OBJ_BUILDING1,  138,  948 )
objects:add(  7, OBJ_BUILDING4,  490, 1989 )
objects:add(  8, OBJ_BUILDING1, 2144, 1917 )
objects:add(  9, OBJ_PILE, 1345, 1446 )
objects:add( 10, OBJ_PILE,  776, 1517 )
objects:add( 11, OBJ_PILE,  496,  724 )
objects:add( 12, OBJ_PILE, 1722,  628 )
objects:add( 13, OBJ_PILE, 1941, 1918 )
objects:add( 14, OBJ_PILE,  444, 2017 )

-- Teleporter
objects:add_special(  1, SPOBJ_TELEPORT1, 1105, 4109, 15 )
objects:add_special(  2, SPOBJ_TELEPORT1, 1081, 4123, 14 )
objects:add_special(  3, SPOBJ_TELEPORT1, 1071, 4158, 13 )
objects:add_special(  4, SPOBJ_TELEPORT1, 1108, 4154, 12)
objects:add_special(  5, SPOBJ_TELEPORT1, 1137, 4130, 11 )
objects:add_special(  6, SPOBJ_TELEPORT1, 1110, 4135, 10 )
objects:add_special(  7, SPOBJ_TELEPORT1, 1136, 4115, 9 )
objects:add_special(  8, SPOBJ_TELEPORT1, 1144, 4156, 8 )
objects:add_special(  9, SPOBJ_TELEPORT1, 1136, 4169, 7 )
objects:add_special( 10, SPOBJ_TELEPORT1, 1110, 4173, 6 )
objects:add_special( 11, SPOBJ_TELEPORT1, 1097, 4171, 5 )
objects:add_special( 12, SPOBJ_TELEPORT1, 1094, 4149, 4 )
objects:add_special( 13, SPOBJ_TELEPORT1, 1171, 4158, 3 )
objects:add_special( 14, SPOBJ_TELEPORT1, 1167, 4142, 2 )
objects:add_special( 15, SPOBJ_TELEPORT1, 1159, 4128, 1 )
objects:add_special( 16, SPOBJ_TELEPORT1, 1126, 4129, 16 )

-- Respawning Extras
dofile("./levels/libextra.sc")

add_respawning_extra(410, 703, 100, 60)
add_respawning_extra(1912, 609, 100, 60)

-- OSD am oberen Bildrand erstellen (Schiffs-Integritaet)
ship_osd = playmap[1].osd:add( 1, 20, 10, 450, 16, OSDBIT_SCREEN )
if (globals.language == LANG_DE) then
  shiposd_txt = "Schiffs-Integritaet"
else
  shiposd_txt = "Ship Integrity"
end

ship_osd:draw_text(FONT_IMPACT10, shiposd_txt, 0, 0)
ship_osd:draw_rectangle(globals.col_white, 120, 1, 449, 11)
ship_osd:draw_filled_rectangle(globals.col_green, 121, 2, 448, 10)


-- einige Variablen
seite = 0                -- temporaere Variable fuer einzuschl. Route
mission_status = 0       -- Missionsstatus (1 = Rueckflug, 2 = angekommen, 3 = failed)
pause_production = 1     -- Schiffsproduktion anhalten?
newenemy_time = 20 * 60  -- Zeit fuer neues Schiff (20 Sekunden)
cur_newenemy_time = newenemy_time
create_bigblues = 0
bigblues_created = 0
player_started = 0       -- temp
relash_start_counter = 60*10 -- temp
relash_killemall = 0
mission_done_counter = 60*3
factory_counter = 60*30
relash_alive = 1

globals.do_all_hooks = 0
globals.score_per_second = 1

-- Blaue Gegner
function _sptow_create_blue_route_1( num, startwp )
  local spd = 0.8
  local bl
  if (create_bigblues == 0) then
    bl = enemies:add( num, E_SHIP_BLUE1, 0, 0, 0, 80, 500, 4, 1, 0 )
  else
    bl = enemies:add( num, E_SHIP_BLUE2, 0, 0, 0, 80, 500, 4, 1, 0 )
    spd = 1.0
  end
  bl.wp:add( 1111, 4144, spd )
  bl.wp:add(  357, 4104, spd )
  bl.wp:add(  339, 1954, spd )
  bl.wp:add(  519+math.random(100)-50, 1775+math.random(100)-50, spd+(math.random(8)-4)/10 )
  bl.wp:add(  505+math.random(100)-50, 1238+math.random(100)-50, spd+(math.random(8)-4)/10 )
  bl.wp:add(  478+math.random(100)-50,  941+math.random(100)-50, spd+(math.random(8)-4)/10 )
  bl.wp:add( 1311+math.random(100)-50, 1028+math.random(100)-50, spd+(math.random(8)-4)/10 )
  bl.wp:add( 1197+math.random(100)-50, 1176+math.random(100)-50, spd+(math.random(8)-4)/10 )
  bl.wp:add( 1464+math.random(100)-50, 1455+math.random(100)-50, spd+(math.random(8)-4)/10 )
  bl.wp:add( 1914+math.random(100)-50, 1548+math.random(100)-50, spd+(math.random(8)-4)/10 )
  bl.wp:add( 2035, 1838, spd )
  bl.wp:add( 1833, 1873, spd )
  bl.wp:add( 1835, 4104, spd )

  bl.wp:set_current(startwp)
  local mywp = bl.wp:get(startwp)
  bl:set_x( mywp:get_x() )
  bl:set_y( mywp:get_y() )

  bl:set_do_hooks(1)
end

function _sptow_create_blue_route_2( num, startwp )
  local spd = 0.8
  local bl
  if (create_bigblues == 0) then
    bl = enemies:add( num, E_SHIP_BLUE1, 0, 0, 0, 80, 500, 4, 1, 0 )
  else
    bl = enemies:add( num, E_SHIP_BLUE2, 0, 0, 0, 80, 500, 4, 1, 0 )
    spd = 1.3
  end
  bl.wp:add( 1123, 4138, spd )
  bl.wp:add( 1838, 4112, spd )
  bl.wp:add( 1827, 1857, spd )
  bl.wp:add( 1620+math.random(100)-50, 1848+math.random(100)-50, spd+(math.random(8)-4)/10 )
  bl.wp:add( 1640+math.random(50)-25, 1643+math.random(100)-50, spd+(math.random(8)-4)/10 )
  bl.wp:add( 1329+math.random(100)-50, 1354+math.random(100)-50, spd+(math.random(8)-4)/10 )
  bl.wp:add( 1053+math.random(100)-50, 1053+math.random(100)-50, spd+(math.random(8)-4)/10 )
  bl.wp:add(  841+math.random(100)-50, 1371+math.random(100)-50, spd+(math.random(8)-4)/10 )
  bl.wp:add(  562+math.random(100)-50, 1211+math.random(100)-50, spd+(math.random(8)-4)/10 )
  bl.wp:add(  603, 1816, spd )
  bl.wp:add(  341, 1964, spd )
  bl.wp:add(  360, 4102, spd )
  bl.wp:add(  935, 4087, spd )

  bl.wp:set_current(startwp)
  local mywp = bl.wp:get(startwp)
  bl:set_x( mywp:get_x() )
  bl:set_y( mywp:get_y() )

  bl:set_do_hooks(1)
end

-- Blaue, Route 1
for n = 1, 13 do
  _sptow_create_blue_route_1( n, n-1 )
end

-- Blaue, Route 2
for n = 1, 13 do
  _sptow_create_blue_route_2( 14+n, n-1 )
end

-- Mr. Relash
relash_speed = 0.25
relash = enemies:add( 47, E_SHIP_RELASH, 415, 564, player[1]:get_sig(), 0, 0, 0, 0, 0 )
relash.wp:add(  415,  564, relash_speed, 60 )
relash.wp:add(  575,  679, relash_speed )
relash.wp:add(  647,  899, relash_speed )
relash.wp:add(  488, 1382, relash_speed )
relash.wp:add(  340, 1974, relash_speed )
relash.wp:add(  357, 4104, relash_speed )
relash.wp:add(  953, 4093, relash_speed )
relash.wp:add( 1110, 4135, relash_speed, 60*30 )
WP_FACTORY = 7
relash.wp:add( 1289, 4105, relash_speed*2 )
relash.wp:add( 1843, 4092, relash_speed*2 )
relash.wp:add( 1840, 1828, relash_speed*2 )
relash.wp:add( 1446, 1430, relash_speed*2 )
relash.wp:add( 1406, 1022, relash_speed*2 )
relash.wp:add(  650,  873, relash_speed*2 )
relash.wp:add(  374,  493, relash_speed*2 )
relash.wp:add(  345,  445, 0.1 )
WP_END = 15
relash:set_maxhit(100)
relash:set_do_hooks(1)

-- bei Tod eines Gegners Projektil-Schockwelle erzeugen
function hook_enemy_dead_0( en )
  if (en:get_type() == E_SHIP_BLUE1) then
    local n
    for n = 1, 360, 20 do
      local b = effects.bullets:add(W_SINGLE, .1, en:get_nr(), en:get_x()+en:get_width()/2, en:get_y()+en:get_height()/2,
                                    math.sin(math.rad(n))*3, math.cos(math.rad(n))*3, 2, 2, 2, 0, 0)
      b:set_ttl(70)
    end
    for n = 1, 360, 30 do
      local b = effects.bullets:add(W_SINGLE, -1, en:get_nr(), en:get_x()+en:get_width()/2, en:get_y()+en:get_height()/2,
                                    math.sin(math.rad(n))*2, math.cos(math.rad(n))*2, 2, 2, 2, 0, 0)
      b:set_ttl(100)
    end
  end
  
  if (en:get_nr() == 47) then
    myosd:draw_typewriter_text(text_relash_helpme5, 10, 2, 0)
    mission_status = 3
    relash_alive = 0
  end
end

-- Wenn Relash kollidiert, Feind zerstoeren und 25 Hitpoints abziehen
function hook_enemy_with_enemy_0( en1, en2 )
  if (en1:get_nr() == 47) then
    en2:set_hit( en2:get_maxhit() + 1 )
    if (en2:get_type() == E_SHIP_BLUE1) then
      en1:hit(-1, en2:get_nr(), 8)
    else
      en1:hit(-1, en2:get_nr(), 15)
    end
  end
end

-- OSD updaten, wenn Relash getroffen
function hook_enemy_hit_0( en, weap, strength )
  if (en:get_nr() == 47) then
    ship_osd:draw_filled_rectangle(0, 121, 2, 448, 10)
    local col
    local myhit = en:get_hit() + strength
    if (myhit < 33) then col = globals.col_green
    elseif (myhit < 66) then col = globals.col_yellow
    else col = globals.col_orange end
    if (myhit < 100) then
      ship_osd:draw_filled_rectangle(col, 121, 2, 121+327-327*(myhit / en:get_maxhit()), 10)
    end
  end
end

geschuetz_drehung = 1

function _sptow_relash_killemall()
  geschuetz_drehung = geschuetz_drehung + 0.6
  if (mod(globals.game_time, 8) == 0) then
    local px = relash:get_x()
    local py = relash:get_y()
    local pw = relash:get_width()
    local ph = relash:get_height()
    
    local b = effects.bullets:add(W_SINGLE, player[1]:get_sig(), 47, px+pw/2, py+ph/2,
                                  math.sin(geschuetz_drehung)*3, math.cos(geschuetz_drehung)*3, 6)
    b:set_ttl(220)
    local b = effects.bullets:add(W_SINGLE, player[1]:get_sig(), 47, px+pw/2, py+ph/2,
                                  -math.sin(geschuetz_drehung)*3, -math.cos(geschuetz_drehung)*3, 6)
    b:set_ttl(220)
    
    gsound:play_sound(SOUND_SHOOT_SINGLE, px+pw/2, py+pw/2)
    
    alt_drehung = geschuetz_drehung
  end
end

myosd = playmap[1].osd:get_osdbit(1000)
talk_flag = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 }
flyaway_flag = 0

function check_other_stuff() 

  if (mission_status >= 2) then
    mission_done_counter = mission_done_counter - 1
    if (mission_done_counter == 0) then
      if (mission_status == 2) then
        player[1]:set_mission_status(1)
      else
        player[1]:set_mission_status(-1)
      end
    end
  end

  if (myosd:get_active() == 0 and relash_start_counter > 0 ) then 
    relash_start_counter = relash_start_counter - 1
  end

  
 if (relash_alive == 1) then
  
  -- Relash redet
  if (player_started == 0 and myosd:get_active() == 0) then
    myosd:draw_typewriter_text(text_relash_start, 10, 3, 1)
    player_started = 1
  end

  -- OSD ausschalten
  if (myosd:get_active() == 1 and player[1].controls:special() == 1) then
    myosd:set_active(0)
  end
  
  -- Relash startet
  if (relash_start_counter > 1) then
    local mywp = relash.wp:get(0)
    mywp:set_curpause(1)
  elseif (flyaway_flag == 0) then
    pause_production = 0
    flyaway_flag = 1
  end

  -- Relash braucht Hilfe
  if (relash:get_hit() >= 90 and relash:get_hit() < 100 and talk_flag[4] == 0) then
    talk_flag[4] = 1
    myosd:draw_typewriter_text(text_relash_helpme4, 10, 2, 0)
  elseif (relash:get_hit() >= 75 and talk_flag[3] == 0) then
    talk_flag[3] = 1
    myosd:draw_typewriter_text(text_relash_helpme3, 10, 2, 0)
  elseif (relash:get_hit() >= 45 and talk_flag[2] == 0) then
    talk_flag[2] = 1
    myosd:draw_typewriter_text(text_relash_helpme2, 10, 2, 0)
  elseif (relash:get_hit() >= 20 and talk_flag[1] == 0) then
    talk_flag[1] = 1
    myosd:draw_typewriter_text(text_relash_helpme1, 10, 2, 0)
  end

  -- Ecke erreicht?
  if (relash.wp:get_current() == WP_FACTORY-1) then
    if (talk_flag[5] == 0) then
      talk_flag[5] = 1
      myosd:draw_typewriter_text(text_relash_target_in_sight, 10, 2, 0)
    end
  end
  
  -- Fabrik erreicht?
  if (relash.wp:get_current() == WP_FACTORY) then
    if (talk_flag[6] == 0) then
      talk_flag[6] = 1
      myosd:draw_typewriter_text(text_relash_target_reached, 10, 2, 0)
      pause_production = 1
    end
    
    if (factory_counter == 0) then
      myosd:draw_typewriter_text(text_relash_ready, 10, 2, 0)
    else
      factory_counter = factory_counter - 1
    end
  end

  if (relash.wp:get_current() == WP_FACTORY+2 and factory_counter == 0) then
    factory_counter = 1
    pause_production = 0
    newenemy_time = 60*5
    create_bigblues = 1
    cur_newenemy_time = newenemy_time
  end
  
  -- Tunnelausgang erreicht?
  if (relash.wp:get_current() == WP_FACTORY+4) then
    if (talk_flag[7] == 0) then
      talk_flag[7] = 1
      myosd:draw_typewriter_text(text_relash_killemall, 10, 2, 0)
      relash_killemall = 1
    end
  end

  -- Feuern
  if (relash_killemall == 1) then 
    _sptow_relash_killemall()
  end

  -- Letzten Waypoint erreicht?
  if (relash.wp:get_current() == WP_END-1) then
    if (talk_flag[8] == 0) then
      talk_flag[8] = 1
      myosd:draw_typewriter_text(text_relash_alldone, 10, 2, 0)
      relash_killemall = 0
    end
  end

  if (relash.wp:get_current() == WP_END) then
    if (talk_flag[9] == 0) then
      talk_flag[9] = 1
      mission_status = 2
    end
  end
                
  -- Distanz zu Relash in Auftank-Reichweite?
  if (distance(player[1]:get_x(), player[1]:get_y(), relash:get_x()+relash:get_width()/2, relash:get_y()+relash:get_height()/2) < 200) then
    if (player[1]:get_fuel() < 99) then
      player[1]:set_fuel(player[1]:get_fuel()+0.1)
    end
  end
  
  -- Zeit, bis neuer Gegner erscheint, vermindern
  if (pause_production == 0) then
    cur_newenemy_time = cur_newenemy_time - 1
  end

  -- Neuen Gegner erstellen, wenn Zeit abgelaufen
  if (cur_newenemy_time == 0) then
    if (create_bigblues == 1) then
      if (bigblues_created == 1 or bigblues_created == 2 or
          bigblues_created == 4 or bigblues_created == 6 or
          bigblues_created == 8 or bigblues_created == 10) then
        _sptow_create_blue_route_2( 14, 0 )
      else
        _sptow_create_blue_route_1( 13, 0 )
      end
      bigblues_created = bigblues_created + 1
    elseif (seite == 0) then
      _sptow_create_blue_route_1( 13, 0 )
      seite = 1
    elseif (seite == 1) then
      _sptow_create_blue_route_2( 14, 0 )
      seite = 0
    end

    cur_newenemy_time = newenemy_time
  end
  
 end
 
end
