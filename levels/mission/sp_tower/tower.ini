-- The Tower
-- INI file

-- Basen erstellen
bases:add(  0, PLAYER_BASE,  308,  733 )
bases:add(  1, PLAYER_BASE, 1784,  637 )

bases:add(  2, ENEMY_BASE_LEFT, 1592, 1937 )
bases:add(  3, ENEMY_BASE_MIDDLE, 1601, 1937 )
bases:add(  4, ENEMY_BASE_MIDDLE, 1640, 1937 )
bases:add(  5, ENEMY_BASE_MIDDLE, 1677, 1937 )
bases:add(  6, ENEMY_BASE_MIDDLE, 1715, 1937 )
bases:add(  7, ENEMY_BASE_RIGHT, 1754, 1937 )
bases:add(  8, ENEMY_BASE_MIDDLE,  815, 1453 )
bases:add(  9, ENEMY_BASE_MIDDLE,  855, 1453 )
bases:add( 10, ENEMY_BASE_MIDDLE,  895, 1453 )
bases:add( 11, ENEMY_BASE_MIDDLE,  933, 1453 )
bases:add( 12, ENEMY_BASE_MIDDLE, 1168, 1452 )
bases:add( 13, ENEMY_BASE_MIDDLE, 1206, 1452 )
bases:add( 14, ENEMY_BASE_MIDDLE, 1246, 1452 )
bases:add( 15, ENEMY_BASE_MIDDLE, 1286, 1452 )

-- Objekte
objects:add(  4, OBJ_BUILDING1,   64,  951 )
objects:add(  5, OBJ_BUILDING1,  101,  950 )
objects:add(  6, OBJ_BUILDING1,  138,  948 )
objects:add(  7, OBJ_BUILDING4,  490, 1989 )
objects:add(  8, OBJ_BUILDING1, 2144, 1917 )
objects:add(  9, OBJ_PILE, 1345, 1446 )
objects:add( 10, OBJ_PILE,  776, 1517 )
objects:add( 11, OBJ_PILE,  496,  724 )
objects:add( 12, OBJ_PILE, 1722,  628 )
objects:add( 13, OBJ_PILE, 1941, 1918 )
objects:add( 14, OBJ_PILE,  444, 2017 )

-- Generatoren, Teleporter
bgr = objects:add( 100, OBJ_BUILDING_GRAV,  977, 3210 )
bgr:set_maxhit(50)
bgr:set_do_hooks(1)
bgr = objects:add( 101, OBJ_BUILDING_GRAV, 1077, 3211 )
bgr:set_maxhit(50)
bgr:set_do_hooks(1)
bgr = objects:add( 102, OBJ_BUILDING_GRAV, 1169, 3211 )
bgr:set_maxhit(50)
bgr:set_do_hooks(1)
bgr = objects:add( 103, OBJ_BUILDING_GRAV, 1275, 3061 )
bgr:set_maxhit(50)
bgr:set_do_hooks(1)

objects:add_special(  0, SPOBJ_TELEPORT1,  999, 3068, 12 )
objects:add_special(  1, SPOBJ_TELEPORT1, 1105, 4109, 15 )
objects:add_special(  2, SPOBJ_TELEPORT1, 1081, 4123, 14 )
objects:add_special(  3, SPOBJ_TELEPORT1, 1071, 4158, 13 )
objects:add_special(  4, SPOBJ_TELEPORT1, 1108, 4154, 0 )
objects:add_special(  5, SPOBJ_TELEPORT1, 1137, 4130, 11 )
objects:add_special(  6, SPOBJ_TELEPORT1, 1110, 4135, 10 )
objects:add_special(  7, SPOBJ_TELEPORT1, 1136, 4115, 9 )
objects:add_special(  8, SPOBJ_TELEPORT1, 1144, 4156, 8 )
objects:add_special(  9, SPOBJ_TELEPORT1, 1136, 4169, 0 )
objects:add_special( 10, SPOBJ_TELEPORT1, 1110, 4173, 6 )
objects:add_special( 11, SPOBJ_TELEPORT1, 1097, 4171, 0 )
objects:add_special( 12, SPOBJ_TELEPORT1, 1094, 4149, 4 )
objects:add_special( 13, SPOBJ_TELEPORT1, 1171, 4158, 3 )
objects:add_special( 14, SPOBJ_TELEPORT1, 1167, 4142, 2 )
objects:add_special( 15, SPOBJ_TELEPORT1, 1159, 4128, 1 )
objects:add_special( 16, SPOBJ_TELEPORT1, 1126, 4129, 0 )

-- Respawning Extras
dofile("./levels/libhelp.sc")

add_respawning_extra(243, 703, 20, 60)
add_respawning_extra(1912, 609, 20, 60)

-- Blaue Gegner
function _sptow_create_blue_route_1( num, startwp )
  local spd = 0.8
  local bl = enemies:add( num, E_SHIP_BLUE1, 0, 0, 0, 80, 500, 4, 1, 0 )
  bl.wp:add( 1111, 4144, spd )
  bl.wp:add(  357, 4104, spd )
  bl.wp:add(  339, 1954, spd )
  bl.wp:add(  519, 1775, spd )
  bl.wp:add(  505, 1238, spd )
  bl.wp:add(  478,  941, spd )
  bl.wp:add( 1311, 1028, spd )
  bl.wp:add( 1197, 1176, spd )
  bl.wp:add( 1464, 1455, spd )
  bl.wp:add( 1914, 1548, spd )
  bl.wp:add( 2035, 1838, spd )
  bl.wp:add( 1833, 1873, spd )
  bl.wp:add( 1835, 4104, spd )

  bl.wp:set_current(startwp)
  local mywp = bl.wp:get(startwp)
  bl:set_x( mywp:get_x() )
  bl:set_y( mywp:get_y() )

  bl:set_do_hooks(1)
end

function _sptow_create_blue_route_2( num, startwp )
  local spd = 0.8
  local bl = enemies:add( num, E_SHIP_BLUE1, 0, 0, 0, 80, 500, 4, 1, 0 )
  bl.wp:add( 1123, 4138, spd )
  bl.wp:add( 1838, 4112, spd )
  bl.wp:add( 1827, 1857, spd )
  bl.wp:add( 1620, 1848, spd )
  bl.wp:add( 1640, 1643, spd )
  bl.wp:add( 1329, 1354, spd )
  bl.wp:add( 1053, 1053, spd )
  bl.wp:add(  841, 1371, spd )
  bl.wp:add(  562, 1211, spd )
  bl.wp:add(  603, 1816, spd )
  bl.wp:add(  341, 1964, spd )
  bl.wp:add(  360, 4102, spd )
  bl.wp:add(  935, 4087, spd )

  bl.wp:set_current(startwp)
  local mywp = bl.wp:get(startwp)
  bl:set_x( mywp:get_x() )
  bl:set_y( mywp:get_y() )

  bl:set_do_hooks(1)
end

-- Blaue, Route 1
for n = 1, 13 do
  _sptow_create_blue_route_1( n, n-1 )
end

-- Blaue, Route 2
for n = 1, 13 do
  _sptow_create_blue_route_2( 14+n, n-1 )
end

-- fahrbare Geschuetze
mytow = enemies:add( 100, E_TANK_MOBILETOWER, 822, 1446, 0, E_TOWER_SINGLE, 10, 700, 3, 2 )
mytow.wp:add( 822, 1446, 0.1 )
mytow.wp:add( 888, 1446, 0.3 )
mytow:set_maxhit(20)
mytow = enemies:add( 101, E_TANK_MOBILETOWER, 900, 1446, 0, E_TOWER_FLAK, 60, 700, 3, 2 )
mytow.wp:add( 900, 1446, 0.3 )
mytow.wp:add( 956, 1446, 0.4 )
mytow:set_maxhit(20)
mytow = enemies:add( 102, E_TANK_MOBILETOWER, 1173, 1445, 0, E_TOWER_THREE, 20, 700, 3, 2 )
mytow.wp:add( 1173, 1445, 0.2 )
mytow.wp:add( 1240, 1445, 0.3 )
mytow:set_maxhit(20)
mytow = enemies:add( 103, E_TANK_MOBILETOWER, 1270, 1445, 0, E_TOWER_PULSE, 20, 700, 3, 2 )
mytow.wp:add( 1270, 1445, 0.2 )
mytow.wp:add( 1312, 1445, 0.2 )
mytow:set_maxhit(20)
mytow = enemies:add( 104, E_TANK_MOBILETOWER, 1597, 1930, 0, E_TOWER_PULSE, 10, 400, 3, 2 )
mytow.wp:add( 1597, 1930, 0.4 )
mytow.wp:add( 1751, 1930, 0.4 )
mytow:set_maxhit(20)

-- fliegende Geschuetze
mytow = enemies:add( 105, E_TANK_FLYINGTOWER, 967, 4315, 0, E_TOWER_SINGLE, 5, 700, 3, 1 )
mytow.wp:add(  967, 4315, 0.5 )
mytow.wp:add( 1061, 4314, 0.5 )
mytow:set_maxhit(40)
mytow = enemies:add( 106, E_TANK_FLYINGTOWER, 1134, 4310, 0, E_TOWER_THREE, 10, 700, 3, 1 )
mytow.wp:add( 1134, 4310, 0.5 )
mytow.wp:add( 1264, 4302, 0.5 )
mytow:set_maxhit(40)
mytow = enemies:add( 107, E_TANK_FLYINGTOWER, 348, 4161, 0, E_TOWER_FLAK, 10, 1000, 5, 1 )
mytow.wp:add(  348, 4161, 0.5 )
mytow.wp:add(  401, 4166, 0.5 )
mytow:set_maxhit(40)
mytow = enemies:add( 108, E_TANK_FLYINGTOWER, 450, 4162, 0, E_TOWER_PULSE, 5, 700, 3, 1 )
mytow.wp:add( 450, 4162, 0.6 )
mytow.wp:add( 900, 4164, 0.6 )
mytow:set_maxhit(40)
mytow = enemies:add( 109, E_TANK_FLYINGTOWER, 1827, 4162, 0, E_TOWER_PULSE, 5, 700, 3, 1 )
mytow.wp:add( 1827, 4162, 0.5 )
mytow.wp:add( 1899, 4164, 0.5 )
mytow:set_maxhit(40)
mytow = enemies:add( 110, E_TANK_FLYINGTOWER, 1750, 4162, 0, E_TOWER_FLAK, 10, 1000, 2, 1 )
mytow.wp:add( 1770, 4162, 0.6 )
mytow.wp:add( 1300, 4163, 0.6 )
mytow:set_maxhit(40)
mytow = enemies:add( 111, E_TANK_FLYINGTOWER, 1441, 1606, 0, E_TOWER_SINGLE, 5, 700, 3, 1 )
mytow.wp:add( 1441, 1606, 0.5 )
mytow.wp:add( 1608, 1808, 0.5 )
mytow:set_maxhit(25)
mytow = enemies:add( 112, E_TANK_FLYINGTOWER, 600, 2012, 0, E_TOWER_PULSE, 10, 700, 3, 1 )
mytow.wp:add(  600, 2012, 0.5 )
mytow.wp:add(  737, 1746, 0.5 )
mytow:set_maxhit(25)

-- normale Shooter
enemies:add( 120, E_TOWER_SINGLE, 46, 871, 0, D_RIGHT, 10, 800, 4, 1 )
enemies:add( 121, E_TOWER_SINGLE, 46, 886, 0, D_RIGHT, 10, 800, 4, 1 )
enemies:add( 122, E_TOWER_SINGLE, 1014, 1495, 0, D_UP, 10, 800, 4, 1 )
enemies:add( 123, E_TOWER_SINGLE, 1142, 1492, 0, D_UP, 10, 800, 4, 1 )
enemies:add( 124, E_TOWER_SINGLE, 2158, 1689, 0, D_LEFT, 10, 800, 4, 1 )
enemies:add( 125, E_TOWER_SINGLE, 2158, 1718, 0, D_LEFT, 10, 800, 4, 1 )
enemies:add( 126, E_TOWER_SINGLE, 2163, 1755, 0, D_LEFT, 10, 800, 4, 1 )
enemies:add( 127, E_TOWER_SINGLE,  870, 1759, 0, D_LEFT, 10, 800, 4, 1 )
enemies:add( 128, E_TOWER_SINGLE,  869, 1780, 0, D_LEFT, 10, 800, 4, 1 )
enemies:add( 129, E_TOWER_SINGLE,  870, 1806, 0, D_LEFT, 10, 800, 4, 1 )
enemies:add( 130, E_TOWER_SINGLE,  870, 1846, 0, D_LEFT, 10, 800, 4, 1 )
enemies:add( 131, E_TOWER_SINGLE,  278, 2040, 0, D_RIGHT, 10, 800, 4, 1 )
enemies:add( 132, E_TOWER_SINGLE,  271, 2061, 0, D_RIGHT, 10, 800, 4, 1 )

-- einige Variablen
generator_count = 4   -- wie viele Generatoren sind noch aktiv?
seite = 0             -- temporaere Variable fuer einzuschl. Route
mission_status = 0    -- Missionsstatus (1 = erledigt, 2 = Ende)

globals.score_per_second = 1

-- Turm: Gegnerparameter
bt_xpos = 1047
bt_ypos = 1505
bt_start_nr = 1000
bt_rocket_strength = 5
bt_rocket_turn = 0.05
bt_rocket_cycle = 4
bt_door_killcount = 60

-- Turm einbinden                
dofile(LEVEL_DIR .. "/bigtower/bigtower.ini")

function hook_enemy_update_0( en )
  hook_bigtower_enemy_update(en)
end

function hook_enemy_hit_0( en, weap, hitp, sx, sy )
  hook_bigtower_enemy_hit(en,weap,hitp,sx,sy)
end

function hook_enemy_dead_0( en )
  hook_bigtower_enemy_dead(en)

  -- Neuen Gegner erstellen, wenn noch Generatoren vorhanden
  if (generator_count > 0 and en:get_type() == E_SHIP_BLUE1) then
    if (seite == 0) then
      _sptow_create_blue_route_1( en:get_nr(), 0 )
      seite = 1
    else
      _sptow_create_blue_route_2( en:get_nr(), 0 )
      seite = 0
    end
  end

  -- Mission erledigt, wenn Turm zerstoert
  if (mission_status == 0) then
    local myen = enemies:get_enemy( bt_nr_reactor )
    if (not myen) then
      mission_status = 1
      local myosd = playmap[1].osd:get_osdbit(1000)
      local mytext
      if (globals.language == LANG_DE) then
        mytext = "[f:impact14][c:green]GRATULATION![br]" ..
                 "[f:impact10][c:yellow]Raeumen Sie noch ein wenig auf und " ..
                 "kehren Sie dann zurueck zur Basis. Gut gemacht, Commander!"
      else
        mytext = "[f:impact14][c:green]CONGRATULATIONS![br]" ..
                 "[f:impact10][c:yellow]If you want, wipe away the rest of " ..
                 "the enemies and return to your base. Good work, Commander!"
      end
      myosd:draw_typewriter_text(mytext, 10, 3)
    end
  end
end

-- Wenn Generator zerstoert wird, entspr. Turm-Rakete schwaechen
function hook_object_dead_0( ob )
  if (ob:get_type() == OBJ_BUILDING_GRAV) then
    generator_count = generator_count - 1

    if (generator_count == 3) then
      bt_rocket_cycle = 8
      bt_rocket_turn = 0.05
    elseif (generator_count == 2) then
      bt_rocket_cycle = 12
      bt_rocket_turn = 0.03
    elseif (generator_count == 1) then
      bt_rocket_cycle = 16
      bt_rocket_turn = 0.01
    elseif (generator_count == 0) then
      bt_rocket_cycle = 20
      bt_rocket_turn = 0.005
    end
  end
end

function check_other_stuff()
  -- Wenn Spieler auf Heimatbasis landet und Missionsstatus 1: beenden
  if (mission_status == 1 and player[1]:get_land() and player[1]:get_land_base() == 0) then
    player[1]:set_mission_status(1)
  end
end
