-- QD03: Moving Stones
-- init script

-- bases
bases:add( 0, CARGO_BASE,   107,   445 )
bases:add( 1, CARGO_BASE,   442,   444 )

objects:add( 0, OBJ_PILE,   184,  437 )
objects:add( 1, OBJ_PILE,   538,  433 )

-- teleports
objects:add_special( 0, SPOBJ_TELEPORT1,  71, 111, 1 )
objects:add_special( 1, SPOBJ_TELEPORT1, 582, 388, 0 )

objects:add_special( 2, SPOBJ_TELEPORT1, 569,  89, 3 )
objects:add_special( 3, SPOBJ_TELEPORT1,  79, 381, 2 )

-- stones

bigstone1 = 10
bigstone2 = 11
smallstone1 = 12
smallstone2 = 13

objects:add(bigstone1, OBJ_STONE_B1, 120, 100 )
objects:add(bigstone2, OBJ_STONE_B1, 465, 100 )

-- load libs
dofile("./levels/libhelp.sc")

-- define required functions & arrays (waypoints)

p  = {}
wp = {}
cur_waypoint = {}
max_waypoint = {}

p[1] = { x = 120, y = 100 }
p[2] = { x = 465, y = 100 }
p[3] = { x = 465, y = 300 }
p[4] = { x = 120, y = 300 }

wp[bigstone1] = { 1, 2, 3, 4 }
wp[bigstone2] = { 3, 4, 1, 2 }

max_waypoint[bigstone1] = table.getn(wp[bigstone1])
max_waypoint[bigstone2] = table.getn(wp[bigstone2])
cur_waypoint[bigstone1] = 1
cur_waypoint[bigstone2] = 1

function object_2_waypoint( objnum, waypoint, speed )
  if not speed then speed = 500 end
  local obj = objects:get_object(objnum)
  local xspd, yspd = get_speed_2_move_to( obj:get_x(), obj:get_y(), p[wp[objnum][waypoint]].x, p[wp[objnum][waypoint]].y, speed )
  obj:set_xspd(xspd)
  obj:set_yspd(yspd)
end

function check_moving_object( objnum )
  local obj = objects:get_object(objnum)
  local ox = obj:get_x()
  local oy = obj:get_y()
  local dx = p[wp[objnum][cur_waypoint[objnum]]].x
  local dy = p[wp[objnum][cur_waypoint[objnum]]].y
    
  if ( ox > dx-10 and ox < dx+10 and oy > dy-10 and oy < dy+10 ) then
    if cur_waypoint[objnum] < max_waypoint[objnum] then
      cur_waypoint[objnum] = cur_waypoint[objnum] + 1
    else
      cur_waypoint[objnum] = 1
    end

    object_2_waypoint( objnum, cur_waypoint[objnum], 500 )
  end
  
end

object_2_waypoint( bigstone1, cur_waypoint[bigstone1], 1 )
object_2_waypoint( bigstone2, cur_waypoint[bigstone1], 1 )

