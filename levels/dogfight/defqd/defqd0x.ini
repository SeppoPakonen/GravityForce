-- QD01: Green Arena, Test
-- init script

bases:add( 0, CARGO_BASE,   107,   445 )
bases:add( 1, CARGO_BASE,   242,   444 )
bases:add( 2, CARGO_BASE,   367,   445 )
bases:add( 3, CARGO_BASE,   472,   444 )

objects:add( 1, OBJ_PILE,   538,  433 )
objects:add( 2, OBJ_PILE,   235,  433 )

a = enemies:add( 1, E_SHIP_BLUE1, 52, 53, 0, 80, 800, 4, 2, 0 )
--b = enemies:add( 2, E_SHIP_BLUE1, 157, 168, 0, 80, 800, 4, 2, 0 )
--c = enemies:add( 3, E_SHIP_BLUE1, 74, 195, 0, 80, 800, 4, 2, 0 )


function __ki_enemy_target_missiles(en)
  local curbullet
  while (1) do
    if (mod(globals.game_time, 30) == 0) then
      curbullet = effects.bullets:get_first()
      while (curbullet) do
        if (curbullet:get_type() == W_ROCKET) then
          local bx = curbullet:get_x()
          local by = curbullet:get_y()
          local enx = en:get_x() + en:get_width()/2
          local eny = en:get_y() + en:get_height()/2
          local dist = math.sqrt( (enx-bx)^2 + (eny-by)^2 )

          if (dist < 600) then
            local n
            for n = 1, 2 do
              local bxs = curbullet:get_xspd()
              local bys = curbullet:get_yspd()
              local bx = curbullet:get_x()
              local by = curbullet:get_y()

              local enx = en:get_x() + en:get_width()/2 + math.random(10)-5
              local eny = en:get_y() + en:get_height()/2 + math.random(10)-5

              local dist = math.sqrt( (enx-bx)^2 + (eny-by)^2 )

              local xt = bx - enx + bxs
              local yt = by - eny + bys
              local xspd = xt/dist*40
              local yspd = yt/dist*40

              local mybul = effects.bullets:add(W_SHOTGUN, -1, en:get_nr(), enx, eny, xspd, -yspd, 0, 0, 0)
              mybul:set_min_x(enx-300)
              mybul:set_max_x(enx+300)
              mybul:set_min_y(eny-300)
              mybul:set_max_y(eny+300)
            end
          end

          break
        end
        curbullet = curbullet:get_next()
      end
    end
    
    coroutine.yield()
  end
end

dofile("./levels/libki.sc")
--register_enemy_ki(a, __ki_enemy_follow_player, 1.0)
--register_enemy_ki(a, __ki_enemy_kamikaze, 60)
--register_enemy_ki(b, __ki_enemy_follow_player, 0.5)
--register_enemy_ki(c, __ki_enemy_kamikaze, 40)

register_enemy_ki(a, __ki_enemy_target_missiles)
