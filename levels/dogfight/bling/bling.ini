-- Bling-Bling Scramble
-- Initscript

mybase = bases:add(  0, CARGO_BASE,   63,  444 )
mybase = bases:add(  1, CARGO_BASE,  545,  442 )

USER_OBJECT00 = images:load("./bitmap/bling.bmp")
USER_OBJECT01 = images:load("./bitmap/blingfin.bmp")

SOUND_BLING1 = gsound:load_sound("./bitmap/bling1.wav")
SOUND_FIVE1 = gsound:load_sound("./bitmap/five1.wav")
SOUND_BLING2 = gsound:load_sound("./bitmap/bling2.wav")
SOUND_FIVE2 = gsound:load_sound("./bitmap/five2.wav")
SOUND_FINISH = gsound:load_sound("./bitmap/finish.wav")

globals.max_frags = 1000000000
globals.max_time = -1
globals.player_respawn = 240

-- Bling-Positionen
-- Wurde mit Arrays geloest, das sieht professioneller aus...

blingx = {}
blingy = {}
blingx[1], blingy[1] = 328, 213
blingx[2], blingy[2] = 468, 238
blingx[3], blingy[3] = 180, 233
blingx[4], blingy[4] = 278, 372
blingx[5], blingy[5] = 375, 373
blingx[6], blingy[6] =  87, 141
blingx[7], blingy[7] = 563, 140
blingx[8], blingy[8] = 394,  99
blingx[9], blingy[9] = 246,  95

score = {}
score[1] = 0 -- Blings      Spieler 1
score[2] = 0 -- Blings      Spieler 2
score[3] = 0 -- 5 in row's  Spieler 1
score[4] = 0 -- 5 in row's  Spieler 2
score[5] = 0 -- Frags       Spieler 1
score[6] = 0 -- Frags       Spieler 2
score[7] = 0 -- Suicides    Spieler 1
score[8] = 0 -- Suicides    Spieler 2

a = 0
blings_collected = 0
if globals.extra_amount > 0 then
  blings_to_finish = globals.extra_amount * 10
else
  blings_to_finish = math.random(9) * 10 + 10
end

-- Und ein OSD mit Punktzahlen und verbleibenden Blings und und und :)

blingosd = playmap[1].osd:add(0, 50, 5, 86, 21, OSDBIT_SCREEN)
scoreosd = {}
scoreosd[1] = playmap[1].osd:add(1, 152, 284, 44, 20, OSDBIT_SCREEN)
scoreosd[2] = playmap[1].osd:add(2, 440, 289, 44, 20, OSDBIT_SCREEN)

function do_blingbling()
  if blings_collected == blings_to_finish then
    globals.exit_level = 1
  elseif blings_collected == blings_to_finish - 1 then
    USER_OBJECT00 = USER_OBJECT01
    gsound:play_sound(SOUND_FINISH, 100)
    gsound:play_sound(SOUND_FINISH, 100)
    gsound:play_sound(SOUND_FINISH, 100)
    gsound:play_sound(SOUND_FINISH, 100)
  end
  if a == 0 then
    a = 1
  else
    a = mod(a + math.random(8) - 1, 9) + 1
  end
  if blings_collected < blings_to_finish then
    myob = objects:add_special(a, USER_OBJECT00, blingx[a], blingy[a])
  end
  blingosd:clear(globals.col_blue)
  blingosd:draw_rectangle(globals.col_white)
  if blings_to_finish - blings_collected == 100 then
    blingosd:draw_text(FONT_IMPACT14, "BLINGS:100", globals.col_white, 3, 1, 0)
  else
    blingosd:draw_text(FONT_IMPACT14, "BLINGS: " .. (blings_to_finish - blings_collected), globals.col_white, 3, 1, 0)
  end
end

function print_scores()
  if mod(globals.game_time, 2) then
    local n
    for n = 1, 2 do
      scoreosd[n]:clear(globals.col_white)
      scoreosd[n]:draw_rectangle(globals.col_grey)
      scoreosd[n]:draw_text(FONT_LCD, score[n] + score[n+2] + score[n+4] + score[n+6], globals.col_blue, 3, 0, 0)
    end
  end
end

fiveone = 0
fivetwo = 0

function fiver_player(pl)
  local myosd = playmap[1].osd:get_osdbit(1000)
  myosd:clear()
  if pl == 1 then
    fiveone = 0
    score[3] = score[3] + 500
    gsound:play_sound(SOUND_FIVE1, 100)
    gsound:play_sound(SOUND_FIVE1, 100)
    myosd:draw_typewriter_text("[f:impact14][c:green]     FIVE IN A ROW !![w:30][br][f:impact10][c:yellow]  500 EXTRA POINTS FOR PLAYER ONE", 10, 1, 0)
  elseif pl == 2 then
    score[4] = score[4] + 500
    fivetwo = 0
    gsound:play_sound(SOUND_FIVE2, 100)
    gsound:play_sound(SOUND_FIVE2, 100)
    myosd:draw_typewriter_text("[f:impact14][c:green]     FIVE IN A ROW !![w:30][br][f:impact10][c:yellow]  500 EXTRA POINTS FOR PLAYER TWO", 10, 1, 0)
  end
end

function hook_player_with_spobject_0(pl, ob)
  if ob:get_nr() >= 1 and ob:get_nr() <= 9 then
    myob:remove()
    blings_collected = blings_collected + 1

--    if pl:get_sig() == player[1]:get_sig() then
    if rawequal(pl, player[1]) then
      score[1] = score[1] + 50
      fiveone = fiveone + 1
      fivetwo = 0
      gsound:play_sound(SOUND_BLING1, 100)
      gsound:play_sound(SOUND_BLING1, 100)
--    elseif pl:get_sig() == player[2]:get_sig() then
    elseif rawequal(pl, player[2]) then
      score[2] = score[2] + 50
      fivetwo = fivetwo + 1
      fiveone = 0
      gsound:play_sound(SOUND_BLING2, 100)
      gsound:play_sound(SOUND_BLING2, 100)
    end

    if fiveone == 5 then
      fiver_player(1)
    elseif fivetwo == 5 then
      fiver_player(2)
    end
    do_blingbling()
  end
end

function hook_player_dead_0(pl)
  if pl:get_killedby() == -1 then
    if pl:get_sig() == player[1]:get_sig() then score[7] = score[7] - 50
    elseif pl:get_sig() == player[2]:get_sig() then score[8] = score[8] - 50 end
  elseif pl:get_killedby() > -1 then
    if pl:get_sig() == player[1]:get_sig() then score[6] = score[6] + 50
    elseif pl:get_sig() == player[2]:get_sig() then score[5] = score[5] + 50 end
  end
end

globals.use_user_stats = 1
globals.user_stats[2]:set_text("Frags (x50)")
globals.user_stats[3]:set_text("Suicides (x-50)")
globals.user_stats[5]:set_text("Blings collected (x50)")
globals.user_stats[6]:set_text("FIVE IN A ROW's (x500)")
globals.user_stats[8]:set_text("Total Score")
winner_string = "Winner !!"

if LANGUAGE == LANG_DE then
  globals.user_stats[2]:set_text("Abschuesse (x50)")
  globals.user_stats[3]:set_text("Selbstmorde (x-50)")
  globals.user_stats[5]:set_text("Blings gesammelt (x50)")
  globals.user_stats[6]:set_text("FIVE IN A ROW's (x500)")
  globals.user_stats[8]:set_text("Gesamtpunktzahl")
  winner_string = "Sieger !!"
end

globals.user_stats[2]:set_textcolor(globals.col_grey)
globals.user_stats[3]:set_textcolor(globals.col_grey)
globals.user_stats[5]:set_textcolor(globals.col_green)
globals.user_stats[6]:set_textcolor(globals.col_green)
globals.user_stats[8]:set_textcolor(globals.col_white)

globals.user_stats[3]:set_valuecolor(0, globals.col_orange)
globals.user_stats[8]:set_valuecolor(0, globals.col_white)
globals.user_stats[9]:set_valuecolor(0, globals.col_green)
globals.user_stats[3]:set_valuecolor(1, globals.col_orange)
globals.user_stats[8]:set_valuecolor(1, globals.col_white)
globals.user_stats[9]:set_valuecolor(1, globals.col_green)

function hook_exit_level_0()
  globals.user_stats[2]:set_value(0, score[5])
  globals.user_stats[2]:set_value(1, score[6])
  globals.user_stats[3]:set_value(0, score[7])
  globals.user_stats[3]:set_value(1, score[8])
  globals.user_stats[5]:set_value(0, score[1])
  globals.user_stats[5]:set_value(1, score[2])
  globals.user_stats[6]:set_value(0, score[3])
  globals.user_stats[6]:set_value(1, score[4])
  total1 = 22 -- score[1] + score[3] + score[5] + score[7]
  total2 = 33 -- score[2] + score[4] + score[6] + score[8]
  globals.user_stats[8]:set_value(0, total1)
  globals.user_stats[8]:set_value(1, total2)
  if total1 > total2 then
    globals.user_stats[9]:set_value(0, winner_string)
  elseif total2 > total1 then
    globals.user_stats[9]:set_value(1, winner_string)
  end
end

-- Jetzt den ersten Checkpoint erzeugen:

do_blingbling()
