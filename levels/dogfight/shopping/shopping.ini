-- Grenzenlos einkaufen
-- Initscript

if (VERSION >= 0.9) then
  dofile("./levels/compat.lua")
end

player[1]:set_home_x(100+150)
player[1]:set_home_y(100+150)
player[2]:set_home_x(100+640-150)
player[2]:set_home_y(100+150)

start_x = 100
start_y = 100
end_x   = 100 + 640
end_y   = 100 + 480 - 56
player_width = player[1]:get_width()
player_height = player[1]:get_height()
globals.max_time = -1
frags_to_win = globals.max_frags
globals.max_frags = 1000000
globals.extra_amount = 0
globals.particle_gravity = globals.particle_gravity * 1.5
if globals.activate_extra == 1 then ae = 1; sg = 120 end

local n
for n = 1, 2 do
  player[n]:set_weapon(0, W_SINGLE, -1,   0)
  player[n]:set_weapon(1, W_DOUBLE,  0,  15)
  player[n]:set_weapon(2, W_BOMB,    0,  45)
  player[n]:set_weapon(3, W_BIGBOMB, 0,  60)
  player[n]:set_weapon(4, W_ROCKET,  0, 150)
  player[n]:set_weapon(5, W_PROBE,   0, 210)
  if ae then player[n]:set_weapon(0, W_SINGLE, sg, 0) end
end

if globals.computer_player == 1 then
  cg = 1
  strength = globals.computer_player_strength
  globals.computer_player_strength = 5
  player[2]:set_weapon(0, W_SINGLE, -1,  40-strength* 4)
  player[2]:set_weapon(1, W_DOUBLE,  0,  40-strength* 4)
  player[2]:set_weapon(2, W_BOMB,    0, 100-strength*10)
  player[2]:set_weapon(3, W_BIGBOMB, 0, 120-strength*12)
  player[2]:set_weapon(4, W_ROCKET,  0, 400-strength*40)
  player[2]:set_weapon(5, W_PROBE,   1, 500-strength*50)
  if ae then player[2]:set_weapon(0, W_SINGLE, sg, 0) end
  if strength == 0 then player[2]:set_weapon(0, W_SINGLE, 0, 0) end
end

-- Meine Bilder laden, Krach und Geschrei einbinden
coin = {}
coin[1] = images:load("./bitmap/10.bmp")
coin[2] = images:load("./bitmap/20.bmp")
coin[3] = images:load("./bitmap/50.bmp")

shop = {}
shop[1] = images:load("./bitmap/shopred.bmp")
shop[2] = images:load("./bitmap/shopblue.bmp")

sound_coin = {}
sound_coin[1] = gsound:load_sound("./bitmap/10.wav")
sound_coin[2] = gsound:load_sound("./bitmap/20.wav")
sound_coin[3] = gsound:load_sound("./bitmap/50.wav")
sound_shop    = gsound:load_sound("./bitmap/shop.wav")

sound_steal   = gsound:load_sound("./bitmap/steal.wav")
sound_fuel    = gsound:load_sound("./bitmap/fuel.wav")
sound_offline = gsound:load_sound("./bitmap/offline.wav")
sound_mines   = gsound:load_sound("./bitmap/mines.wav")
sound_repair  = gsound:load_sound("./bitmap/repair.wav")

osd = playmap[1].osd:add(0, 0, 0, 640, 480, OSDBIT_SCREEN)

money = {}
money[1] = 0
money[2] = 0

frags = {}
frags[1] = 0
frags[2] = 0

suicides = {}
suicides[1] = 0
suicides[2] = 0

extra = {}
extra[1] = 1
extra[2] = 1

extra_effect = {}
extra_effect[1] = {}
extra_effect[2] = {}
local n
for n = 1, 2 do
  extra_effect[n][2] = 0
  extra_effect[n][6] = 0
  extra_effect[n][7] = 0
end

extra_name = {}
extra_name[1] = ""

if LANGUAGE == LANG_DE then
  mny            = " Geld"
  pwin_string1   = " fuehrt mit "
  pwin_string2   = " Punkt!"
  pwin_string3   = " Punkten!"

  extra_name[2]  = "Gelddruckerei"
  extra_name[3]  = "Geld klauen"
  extra_name[4]  = "Volltanken"
  extra_name[5]  = "Alle Waffen"
  extra_name[6]  = "Systemausfall"
  extra_name[7]  = "Waffen blockieren"
  extra_name[8]  = "Minenfeld"
  extra_name[9]  = "Reparatur"
  extra_name[100]= "Neuer Sprit (250 Geld!)"
else
  mny = " Money"
  pwin_string1   = " is ahead by "
  pwin_string2   = " frag!"
  pwin_string3   = " frags!"

  extra_name[2]  = "Money printer"
  extra_name[3]  = "Steal money"
  extra_name[4]  = "New fuel"
  extra_name[5]  = "All weapons"
  extra_name[6]  = "System failure"
  extra_name[7]  = "Block weapons"
  extra_name[8]  = "Mine field"
  extra_name[9]  = "Repair ship"
  extra_name[100]= "New fuel (250 Money!)"
end


time_to_new_coin1 = 180
time_to_new_coin2 = 1500
time_to_new_shop  = random(300) + 480
next_shop         = 1








-- Hooks

function hook_player_with_spobject_0(pl, ob)
  nr = ob:get_nr()
  if pl:get_sig() == player[1]:get_sig() then p = 1 else p = 2 end

  if nr <= 9 then
    if     mod(nr, 3) == 1 then
      money[p] = money[p] + 10
    elseif mod(nr, 3) == 2 then
      money[p] = money[p] + 20
    elseif mod(nr, 3) == 0 then
      money[p] = money[p] + 50
    end
    gsound:play_sound(sound_coin[mod(nr-1, 3) + 1])
    ob:remove()
    if     nr <= 3 then time_to_new_coin1 = globals.game_time + random(180) + 90
    elseif nr <= 6 then time_to_new_coin2 = globals.game_time + random(180) + 90 end

  elseif nr == 11 or nr == 12 then
    if money[p] >= 100 or (cg and p == 2) then
      xpix = ob:get_x()
      ypix = ob:get_y()
      apix = 1
      cpix = nr - 10
      gsound:play_sound(sound_shop)
      money[p] = money[p] - 100
      ob:remove()
      time_to_new_shop = globals.game_time + random(300) + 300

      if nr == 11 and money[p] >= 0 then
        if ae then r = random(6) else r = random(5) end
        if     r == 1 then
          player[p]:set_weapon_bullets(1, player[p]:get_weapon_bullets(1) + 60)
        elseif r == 2 then
          player[p]:set_weapon_bullets(2, player[p]:get_weapon_bullets(2) + 10)
        elseif r == 3 then
          player[p]:set_weapon_bullets(3, player[p]:get_weapon_bullets(3) + 8)
        elseif r == 4 then
          player[p]:set_weapon_bullets(4, player[p]:get_weapon_bullets(4) + 5)
        elseif r == 5 then
          player[p]:set_weapon_bullets(5, player[p]:get_weapon_bullets(5) + 3)
        elseif r == 6 then
          player[p]:set_weapon_bullets(0, player[p]:get_weapon_bullets(0) + sg)
        end
      elseif money[p] >= 0 then
        if p == 2 and cg then
          use_item(2, extra[2])
          extra[2] = 1
        end
        extra[p] = random(8) + 1
      else money[p] = money[p] + 100 end -- Nur fuer Computergegner!!!

    else
      player[p]:set_dead()
    end
  end -- nr == 11 or nr == 12

end

function hook_player_dead_0(pl)
  if pl:get_sig() == player[1]:get_sig() then p = 1 else p = 2 end

  if pl:get_killedby() <= 0 then
    if     p == 1 then suicides[1] = suicides[1] + 1
    elseif p == 2 then suicides[2] = suicides[2] + 1 end
  elseif pl:get_killedby() > 0 then
    if     p == 2 then frags[1] = frags[1] + 1
    elseif p == 1 then frags[2] = frags[2] + 1 end
  end

  if extra[p] == 100 then extra[p] = 1 end
  if extra_effect[p][2] > 0 then extra_effect[p][2] = 0 end
  if     money[p] >= 50 then
    local  y = random(3)
    objects:add_special(y+6, coin[y], player[p]:get_x(), player[p]:get_y())
    if     y == 1 then money[p] = money[p] - 10
    elseif y == 2 then money[p] = money[p] - 20
    else               money[p] = money[p] - 50 end
  elseif money[p] >= 20 then
    local  y = random(2)
    objects:add_special(y+6, coin[y], player[p]:get_x(), player[p]:get_y())
    if     y == 1 then money[p] = money[p] - 10
    else               money[p] = money[p] - 20 end
  elseif money[p] >= 10 then
    objects:add_special(7,   coin[1], player[p]:get_x(), player[p]:get_y())
    money[p] = money[p] - 10
  end
end

-- Items einsetzen!

function use_item(p, i)
  if     i == 2 then
    extra_effect[p][2] = globals.game_time
    gsound:play_sound(SOUND_MENU_SELECT)
    gsound:play_sound(SOUND_MENU_SELECT)
  elseif i == 3 then
    if p == 1 then money[1] = money[1] + money[2]; money[2] = 0
              else money[2] = money[2] + money[1]; money[1] = 0 end
    gsound:play_sound(sound_steal)
    gsound:play_sound(sound_steal)
  elseif i == 4 then
    player[p]:set_fuel(100)
    if player[p]:get_extra_power() > 0 then player[p]:set_extra_power(100) end
    gsound:play_sound(sound_fuel)
  elseif i == 5 then
    player[p]:set_weapon_bullets(1, player[p]:get_weapon_bullets(1) + 12)
    player[p]:set_weapon_bullets(2, player[p]:get_weapon_bullets(2) + 2)
    player[p]:set_weapon_bullets(3, player[p]:get_weapon_bullets(3) + 2)
    player[p]:set_weapon_bullets(4, player[p]:get_weapon_bullets(4) + 1)
    player[p]:set_weapon_bullets(5, player[p]:get_weapon_bullets(5) + 1)
    gsound:play_sound(SOUND_BEAM_SHIP)
    gsound:play_sound(SOUND_BEAM_SHIP)
  elseif i == 6 then
    extra_effect[3-p][6] = globals.game_time
    if p == 1 and cg then
      save = player[2]:get_player_acc()
      player[2]:set_player_acc(0)
      for a = 1, 6 do
        player[2]:deactivate_weapon_slot(a-1)
      end
    else
      player[3-p].controls:disable()
    end
    gsound:play_sound(sound_offline)
  elseif i == 7 then
    extra_effect[3-p][7] = globals.game_time
    local a
    for a = 1, 6 do
      player[3-p]:deactivate_weapon_slot(a-1)
    end
    gsound:play_sound(sound_offline)
  elseif i == 8 then
    local z
    for z = 1, 12 do
      bul = effects.bullets:add(W_MINE, player[p]:get_sig(), 0,
            player[p]:get_x()+random(90)-45, player[p]:get_y()+random(90)-45, 0, 0, 13, 20)
      bul:set_user(900)
    end
    gsound:play_sound(sound_mines)
  elseif i == 9 then
    player[p]:set_hull       (player[p]:get_max_hull())
    player[p]:set_shield     (player[p]:get_max_shield())
    player[p]:set_wall_shield(player[p]:get_max_wall_shield())
    gsound:play_sound(sound_repair)
  elseif i == 100 then
    money[p] = money[p] - 250
    player[p]:set_fuel(100)
    gsound:play_sound(sound_fuel)
  end

end

-- Die tolle Hauptschleife

function main_loop()
  if time_to_new_coin1 > 0 and globals.game_time > time_to_new_coin1 then
    local y = random(3)
    objects:add_special(y, coin[y], 110 + random(614), 165 + random(255))
    time_to_new_coin1 = 0
  end

  if time_to_new_coin2 > 0 and globals.game_time > time_to_new_coin2 then
    local y = random(3)
    objects:add_special(y+3, coin[y], 110 + random(614), 165 + random(255))
    time_to_new_coin2 = 0
  end

  if time_to_new_shop > 0 and globals.game_time > time_to_new_shop then
    if money[1] >= 100 or money[2] >= 100 then
      local y = next_shop
      shopobj = objects:add_special(10+y, shop[y], 110 + random(600), 165 + random(233), 0, 15)
      next_shop = 3 - next_shop
      time_to_new_shop = 0
    else time_to_new_shop = time_to_new_shop + random(360) end
  end

  if apix then apix = nil
  elseif cpix then
    if cpix == 1 then col1 = PIX_YELLOW; col2 = PIX_RED
                 else col1 = PIX_BLUE; col2 = PIX_BLUE end
    effects.pixels:add(150, xpix+16, ypix+15, 30, 30, -1, -1, 10, col1, 10, 500, 100, 640*2, 400*2)
    effects.pixels:add(150, xpix+16, ypix+15, 30, 30, -1,  1, 10, col1, 10, 500, 100, 640*2, 400*2)
    effects.pixels:add(150, xpix+16, ypix+15, 30, 30,  1, -1, 10, col1, 10, 500, 100, 640*2, 400*2)
    effects.pixels:add(150, xpix+16, ypix+15, 30, 30,  1,  1, 10, col1, 10, 500, 100, 640*2, 440*2)
    effects.pixels:add(100, xpix+16, ypix+15, 30, 30, -2, -2, 20, col2, 10, 500, 100, 640*2, 400*2)
    effects.pixels:add(100, xpix+16, ypix+15, 30, 30, -2,  2, 20, col2, 10, 500, 100, 640*2, 400*2)
    effects.pixels:add(100, xpix+16, ypix+15, 30, 30,  2, -2, 20, col2, 10, 500, 100, 640*2, 400*2)
    effects.pixels:add(100, xpix+16, ypix+15, 30, 30,  2,  2, 20, col2, 10, 500, 100, 640*2, 440*2)
    cpix = nil

  end

  -- Spielersteuerung
  if player[1].controls:special() == 1 and extra[1] > 1 and player[1]:get_dead() == 0 then
    use_item(1, extra[1])
    extra[1] = 1
  end
  if player[2].controls:special() == 1 and extra[2] > 1 and player[2]:get_dead() == 0 and not cg then
    use_item(2, extra[2])
    extra[2] = 1
  end
  if     player[1]:get_fuel() <= 1 and extra[1] == 1   and money[1] >= 250 and player[1]:get_dead() == 0 then extra[1] = 100
  elseif player[1]:get_fuel() <= 1 and extra[1] == 100 and money[1] <  250 then extra[1] = 1 end
  if     player[2]:get_fuel() <= 1 and extra[2] == 1   and money[2] >= 250 and player[2]:get_dead() == 0 then extra[2] = 100
  elseif player[2]:get_fuel() <= 1 and extra[2] == 100 and money[2] <  250 then extra[2] = 1 end

  -- Computer setzt Items ein
  if cg and mod(globals.game_time, 180) == 0 and extra[2] > 1 and player[2]:get_dead() == 0 then
    if (extra[2] == 2 and player[2]:get_hull() == player[2]:get_max_hull()) or
       (extra[2] == 3 and money[1] >= 100) or
       (extra[2] == 4 and player[2]:get_fuel() <= 2) or
       (extra[2] == 5) or
       (extra[2] == 6) or
       (extra[2] == 7) or
       (extra[2] == 8 and sqrt((player[1]:get_x()-player[2]:get_x())^2 + (player[1]:get_y()-player[2]:get_y())^2) <= 150) or
       (extra[2] == 9 and player[2]:get_hull() <= (player[2]:get_max_hull()+2)/2) or
       (extra[2] == 100) then
      use_item(2, extra[2])
      extra[2] = 1
    end
  end

  -- Itemwirkungen
  local a
  for a = 1, 2 do
    if extra_effect[a][2] > 0 and mod(globals.game_time - extra_effect[a][2], 120) == 119 then
      money[a] = money[a] + 10
      gsound:play_sound(SOUND_BEAM_BULLET)
      gsound:play_sound(SOUND_BEAM_BULLET)
    end
    if extra_effect[a][6] > 0 then 
      if globals.game_time >= extra_effect[a][6] + 480 then
        player[a].controls:enable()
        extra_effect[a][6] = 0
        if a == 2 and cg then
          player[2]:set_player_acc(save)
          local j
          for j = 1, 6 do
            if extra_effect[2][7] == 0 then player[2]:activate_weapon_slot(j-1) end
          end
        end
      else
        player[a]:set_head(mod(player[a]:get_head() + 6, 360))
      end
    end
    if extra_effect[a][7] > 0 then 
      if globals.game_time >= extra_effect[a][7] + 900 then
        local s
        for s = 1, 6 do
          if not (a == 2 and cg and extra_effect[2][6] > 0) then player[a]:activate_weapon_slot(s-1) end
        end
        extra_effect[a][7] = 0
      end
    end
  end

  -- OSD-Funktionen

  osd:clear()
  osd:draw_text(FONT_BANK, player[1]:get_name(), globals.col_yellow, 8, 1)
  osd:draw_text(FONT_BANK, player[2]:get_name(), globals.col_yellow, 8, 20)
  if money[1] >= 100 then col1 = globals.col_white else col1 = globals.col_grey end
  if money[2] >= 100 then col2 = globals.col_white else col2 = globals.col_grey end
  osd:draw_text(FONT_BANK, money[1] .. mny, col1, 135, 1)
  osd:draw_text(FONT_BANK, money[2] .. mny, col2, 135, 20)
  osd:draw_text(FONT_BANK, extra_name[extra[1]], globals.tbl_green[10], 260, 1)
  osd:draw_text(FONT_BANK, extra_name[extra[2]], globals.tbl_green[10], 260, 20)

  local sc1 = frags[1]+suicides[2]
  local sc2 = frags[2]+suicides[1]
  if sc1 > sc2 then
    pwin = player[1]:get_name()
    diff = sc1 - sc2
  else
    pwin = player[2]:get_name()
    diff = sc2 - sc1
  end
  if diff == 1 then xx = pwin_string2 else xx = pwin_string3 end
  if sc1 ~= sc2 then
    osd:draw_text(FONT_BANK, pwin .. pwin_string1 .. diff .. xx, globals.col_orange, 8, 39)
  end

  if diff >= frags_to_win or get_key(59) == 1 then
    globals.exit_level = 1
  end







  -- Der ganz normale Kram aus "Grenzenlos" :-)
  local a
  for a = 1, 2 do
    if (player[a]:get_x() > end_x) then 
      player[a]:set_x(start_x - player_width)
    elseif (player[a]:get_x() < start_x - player_width) then
      player[a]:set_x(end_x)
    end

    if (player[a]:get_y() > end_y) then
      player[a]:set_y(start_y - player_height)  
    elseif (player[a]:get_y() < start_y - player_height) then
      player[a]:set_y(end_y)
    end
  end

  local tb = effects.bullets:get_first()
  local sx = start_x
  local sy = start_y
  local ex = end_x
  local ey = end_y
  
  while (tb) do
    local x = tb:get_x()
    local y = tb:get_y()
    local next = tb:get_next()

    if (x > ex) then 
      tb:set_x(sx)
    elseif (x < sx) then
      tb:set_x(ex)
    end
      
    if (y > ey) then 
      tb:set_y(sy)
    elseif (y < sy) then
      tb:set_y(ey)
    end
    
    tb = next
  end
end




-- Highscores
globals.use_user_stats = 1

if LANGUAGE == LANG_DE then
  globals.user_stats[2]:set_text("Abschuesse (x200)")
  globals.user_stats[3]:set_text("Selbstmorde (x-200)")
  globals.user_stats[5]:set_text("Geld (x1)")
  globals.user_stats[7]:set_text("Gesamtpunktzahl")
  winner_string = "Sieger !!"
else
  globals.user_stats[2]:set_text("Frags (x200)")
  globals.user_stats[3]:set_text("Suicides (x-200)")
  globals.user_stats[5]:set_text("Money (x1)")
  globals.user_stats[7]:set_text("Total Score")
  winner_string = "Winner !!"
end

globals.user_stats[7]:set_textcolor(globals.col_white)

globals.user_stats[3]:set_valuecolor(0, globals.col_orange)
globals.user_stats[7]:set_valuecolor(0, globals.col_white)
globals.user_stats[8]:set_valuecolor(0, globals.col_white)
globals.user_stats[3]:set_valuecolor(1, globals.col_orange)
globals.user_stats[7]:set_valuecolor(1, globals.col_white)
globals.user_stats[8]:set_valuecolor(1, globals.col_white)

function hook_exit_level_0()
  globals.user_stats[2]:set_value(0, frags[1]*200)
  globals.user_stats[2]:set_value(1, frags[2]*200)
  globals.user_stats[3]:set_value(0, suicides[1]*(-200))
  globals.user_stats[3]:set_value(1, suicides[2]*(-200))
  globals.user_stats[5]:set_value(0, money[1])
  globals.user_stats[5]:set_value(1, money[2])
  globals.user_stats[7]:set_value(0, frags[1]*200+suicides[1]*(-200)+money[1])
  globals.user_stats[7]:set_value(1, frags[2]*200+suicides[2]*(-200)+money[2])
  total1 = frags[1]*200+suicides[1]*(-200)+money[1]
  total2 = frags[2]*200+suicides[2]*(-200)+money[2]
  if total1 > total2 then
    globals.user_stats[8]:set_value(0, winner_string)
  elseif total2 > total1 then
    globals.user_stats[8]:set_value(1, winner_string)
  end
end
